var v=Object.defineProperty;var L=(r,a,g)=>a in r?v(r,a,{enumerable:!0,configurable:!0,writable:!0,value:g}):r[a]=g;var i=(r,a,g)=>(L(r,typeof a!="symbol"?a+"":a,g),g);(function(r,a){typeof exports=="object"&&typeof module!="undefined"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(r=typeof globalThis!="undefined"?globalThis:r||self,a(r.BdoSharedMessage={}))})(this,function(r){"use strict";const a="__BDO_HOST_IPC_MESSAGE_V1__",g="__BDO_FRAME_IPC_MESSAGE_V1__";class u{constructor(e,s=`${location.protocol}//${location.host}`){i(this,"context",null);i(this,"connected",!1);i(this,"messagegSender",null);i(this,"targetDomain","");i(this,"sourceFlag","HOST");i(this,"messageChannel","default");i(this,"messageDefaultChannel","default");i(this,"messageListeners",new Map);this.context=e,this.targetDomain=s}getListenerEvent(e){return(this.messageChannel||this.messageDefaultChannel)+"::"+e}getListeners(e){return this.messageListeners.get(this.getListenerEvent(e))||[]}addListener(e,s){const n=this.getListeners(this.getListenerEvent(e));n.push(s),this.messageListeners.set(this.getListenerEvent(e),n)}removeListener(e,s){if(!this.messageListeners.has(this.getListenerEvent(e)))return;const n=this.getListeners(this.getListenerEvent(e)),o=n.findIndex(l=>l==s);o>-1&&n.splice(o,1),this.messageListeners.set(this.getListenerEvent(e),n)}removeAllListeners(){this.messageListeners.clear()}getMsgFlag(){return this.sourceFlag==="HOST"?a:g}serializeMessage(e,s){return this.getMsgFlag()+JSON.stringify({event:e,args:s,origin:this.context&&this.context.location.origin})}unserializeMessage(e){const s=e.replace(a,"").replace(g,""),n={event:"",origin:"",args:[]};try{const o=JSON.parse(s)||{};n.event=o.event,n.origin=o.origin,n.args=o.args}catch{}return n}setSourceFlag(e){this.sourceFlag=e}dispatchMessage(e){const s=this.unserializeMessage(e);if(!s.event)return;if(s.event=="on-provider-load")this.connected=!0;else if(s.event=="connect"&&Array.isArray(s.args)&&s.args.length>0){const l=s.args[0]||{};l&&l.origin&&(this.connected=!0,this.setTargetDomain(l.origin),this.send("on-provider-load"));return}this.getListeners(s.event).forEach(l=>{l(s.event,...s.args||[])}),this.getListeners("all").forEach(l=>{l(s.event,...s.args||[])})}setMessageSender(e){this.messagegSender=e}getMessageSender(){return this.messagegSender}setMessageChannel(e){this.messageChannel=e||this.messageDefaultChannel}getMessageChannel(){return this.messageChannel||this.messageDefaultChannel}setTargetDomain(e){this.targetDomain=e}getTargetDomain(){return this.targetDomain}isConnected(){return this.connected}send(e,...s){const n=this.messagegSender||this.context,o=this.serializeMessage(e,s);n&&n.postMessage(o,this.targetDomain)}on(e,s){this.addListener(e,s)}onAll(e){this.addListener("all",e)}once(e,s){const n=new Proxy(s,{apply:(o,l,m)=>{o.apply(l,m),this.removeListener(e,n)}});this.addListener(e,n)}off(e,s){this.removeListener(e,s)}offAll(){this.removeAllListeners()}}class f extends u{constructor(){super(window);i(this,"timer",null)}onmessage(e){if(this.getMessageSender()!==e.source)return;let s=e.data||"";!s.startsWith(g)||s.startsWith(g)&&this.dispatchMessage(s)}init(e,s){window.addEventListener("message",this.onmessage.bind(this),!1);const n=typeof e=="string"?document.querySelector(e):e;n&&n.contentWindow&&this.setMessageSender(n&&n.contentWindow),this.setTargetDomain(s)}testConnect(){this.timer=setTimeout(()=>{if(this.isConnected()){clearTimeout(this.timer);return}this.send("connect",{origin:location.origin}),this.testConnect()},500)}connect(){this.testConnect()}destroy(){window.removeEventListener("message",this.onmessage),this.offAll()}}const t=class{static emit(e,...s){!t.listeners||typeof t.listeners[e]=="function"&&t.listeners[e](...s)}static init(e){const s=Object.assign({mountSelector:"",value:null,providerUrl:"",initData:null,listeners:{}},e);t.msgdata=s.value,t.initData=s.initData,t.listeners=s.listeners,t.mountSelector=s.selector,t.providerUrl=s.providerUrl,t.messageHandler=new f;const n="bdo_msg_shuck_"+new Date().getTime(),l=new URL(t.providerUrl).origin;t.providerFrameId=n,t.providerDomain=l;const m=(c,...h)=>{c=="on-provider-load"?(t.messageHandler&&(t.messageHandler.send("input",t.msgdata),t.messageHandler.send("init",t.initData,{origin:location.origin})),t.emit("trigger",!0)):c=="on-provider-unload"?t.emit("trigger",!1):c=="input"?(t.msgdata=h&&h[0],t.messageHandler.send("input",t.msgdata),t.emit("input",t.msgdata),t.emit("change",t.msgdata)):t.emit(c,...h)};t.messageHandler.on("all",m)}static open(){if(!t.mountSelector)return;const e=document.createElement("iframe");e.id=t.providerFrameId,e.name=t.providerFrameId,e.src=t.providerUrl,e.style.cssText="border: none;width: 100%;height: 100%;",e.onload=()=>{};const s=document.querySelector(t.mountSelector);s&&s.appendChild(e),t.messageHandler.init(`#${t.providerFrameId}`,t.providerDomain),t.messageHandler.connect(),t.emit("input",t.msgdata),t.emit("change",t.msgdata)}static destroy(){t.messageHandler&&t.messageHandler.destroy()}static setValue(e){t.msgdata=e,t.messageHandler.send("input",t.msgdata),t.emit("change",t.msgdata)}static getValue(){return t.msgdata}};let d=t;i(d,"messageHandler"),i(d,"mountSelector"),i(d,"providerFrameId",""),i(d,"providerDomain",""),i(d,"providerUrl",""),i(d,"msgdata",null),i(d,"initData",null),i(d,"listeners",{}),r.MsgShuck_ECMA=d,Object.defineProperty(r,"__esModule",{value:!0}),r[Symbol.toStringTag]="Module"});
